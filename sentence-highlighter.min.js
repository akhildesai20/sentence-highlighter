(function(window) { 'use strict'; class SentenceHighlighter { constructor(editorElement, options = {}) { if (!editorElement || !editorElement.nodeType) { throw new Error('SentenceHighlighter: Valid editor element is required'); } if (!editorElement.isContentEditable) { throw new Error('SentenceHighlighter: Element must be contenteditable'); } this.editor = editorElement; this.options = { sentenceDataAttribute: options.sentenceDataAttribute || 'data-sentence-id', activeSentenceDataAttribute: options.activeSentenceDataAttribute || 'data-sentence-active', containerClass: options.containerClass || 'paragraph', sentenceClass: options.sentenceClass || 'sentence', activeSentenceClass: options.activeSentenceClass || 'sentence--active', enableFocusMode: options.enableFocusMode !== false, focusModeDimOpacity: options.focusModeDimOpacity || 0.18, autoScroll: options.autoScroll !== false, scrollBehavior: options.scrollBehavior || 'smooth', headingTags: options.headingTags || ['h1', 'h2', 'h3'], sentenceEndings: options.sentenceEndings || ['.', '!', '?'], updateDebounce: options.updateDebounce || 100, updateThrottle: options.updateThrottle || 50, onSentenceChange: options.onSentenceChange || null, onActiveSentenceChange: options.onActiveSentenceChange || null, ...options }; this.sentenceMap = new Map(); this.sentenceElements = new Map(); this.activeSentenceId = null; this.isInitialized = false; this.updateTimer = null; this.lastContentHash = null; this.focusModeEnabled = this.options.enableFocusMode; this.handleInput = this.handleInput.bind(this); this.handleNavigation = this.handleNavigation.bind(this); this.handleCaretMove = this.handleCaretMove.bind(this); this.init(); } init() { if (this.isInitialized) return; this.injectCSS(); this.editor.classList.add(this.options.containerClass); if (!this.focusModeEnabled) { this.editor.classList.add('sentence-highlighter-focus-off'); } this.attachEvents(); setTimeout(() => { this.scanAndHighlight(); }, 10); this.isInitialized = true; } injectCSS() { const styleId = 'sentence-highlighter-styles'; if (document.getElementById(styleId)) return; const style = document.createElement('style'); style.id = styleId; style.textContent = ` .${this.options.containerClass} .${this.options.sentenceClass} { opacity: ${this.options.focusModeDimOpacity}; transition: opacity 0.18s ease, color 0.18s ease; } .${this.options.containerClass} .${this.options.sentenceClass}.${this.options.activeSentenceClass}, .${this.options.containerClass} .${this.options.sentenceClass}[${this.options.activeSentenceDataAttribute}] { opacity: 1 !important; } .sentence-highlighter-focus-off .${this.options.containerClass} .${this.options.sentenceClass} { opacity: 1; } `; document.head.appendChild(style); } attachEvents() { this.editor.addEventListener('input', this.handleInput); this.editor.addEventListener('keydown', (e) => { if (this.options.sentenceEndings.includes(e.key)) { clearTimeout(this.updateTimer); this.updateTimer = setTimeout(() => { this.scanAndHighlight(); }, 20); } }); this.editor.addEventListener('click', this.handleNavigation); this.editor.addEventListener('keyup', (e) => { const navigationKeys = [ 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown' ]; if (navigationKeys.includes(e.key)) { this.handleNavigation(); } }); document.addEventListener('selectionchange', this.handleCaretMove); this.editor.addEventListener('focus', () => this.handleNavigation()); } handleInput() { const text = this.getPlainText(); const caretOffset = this.getCaretOffset(); let shouldUpdateImmediately = false; if (caretOffset > 1) { const charBefore = text[caretOffset - 2]; if (this.options.sentenceEndings.includes(charBefore)) { shouldUpdateImmediately = true; } } clearTimeout(this.updateTimer); const delay = shouldUpdateImmediately ? 10 : this.options.updateDebounce; this.updateTimer = setTimeout(() => { this.scanAndHighlight(); }, delay); } handleNavigation() { clearTimeout(this.updateTimer); this.updateTimer = setTimeout(() => { this.updateActiveSentence(); }, this.options.updateThrottle); } handleCaretMove() { if (!this.editor.contains(window.getSelection()?.anchorNode)) { return; } clearTimeout(this.updateTimer); this.updateTimer = setTimeout(() => { this.updateActiveSentence(); }, this.options.updateThrottle); } generateSentenceId(start, end, text, isHeading) { const hash = this.simpleHash(`${start}-${end}-${text.substring(0, 20)}-${isHeading}`); return `sentence-${hash}`; } simpleHash(str) { let hash = 0; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash = hash & hash; } return Math.abs(hash).toString(36); } getCaretOffset() { const selection = window.getSelection(); if (!selection || selection.rangeCount === 0) return 0; const range = selection.getRangeAt(0); const preRange = range.cloneRange(); preRange.selectNodeContents(this.editor); preRange.setEnd(range.endContainer, range.endOffset); return preRange.toString().length; } setCaretOffset(targetOffset) { const selection = window.getSelection(); const range = document.createRange(); let currentOffset = 0; let found = false; const traverse = (node) => { if (found) return; if (node.nodeType === Node.TEXT_NODE) { const text = node.textContent || ""; const nextOffset = currentOffset + text.length; if (targetOffset <= nextOffset) { const localOffset = targetOffset - currentOffset; range.setStart(node, Math.max(0, localOffset)); range.collapse(true); found = true; return; } currentOffset = nextOffset; } else if (node.nodeType === Node.ELEMENT_NODE) { for (let i = 0; i < node.childNodes.length; i++) { traverse(node.childNodes[i]); if (found) return; } } }; traverse(this.editor); if (!found) { range.selectNodeContents(this.editor); range.collapse(false); } selection.removeAllRanges(); selection.addRange(range); } buildSentenceMap() { const text = this.getPlainText(); if (!text.trim()) { return []; } const sentences = []; const pattern = `[^${this.options.sentenceEndings.map(e => '\\' + e).join('')}]+[${this.options.sentenceEndings.map(e => '\\' + e).join('')}]?\\s*`; const regex = new RegExp(pattern, 'g'); let match; let lastIndex = 0; while ((match = regex.exec(text)) !== null) { const chunk = match[0]; const start = match.index; const end = start + chunk.length; const id = this.generateSentenceId(start, end, chunk, false); sentences.push({ id: id, text: chunk, start: start, end: end, isHeading: false }); lastIndex = regex.lastIndex; } if (lastIndex < text.length) { const remaining = text.substring(lastIndex); if (remaining.trim().length > 0) { const id = this.generateSentenceId(lastIndex, text.length, remaining, false); sentences.push({ id: id, text: remaining, start: lastIndex, end: text.length, isHeading: false }); } } if (sentences.length === 0 && text.trim().length > 0) { const id = this.generateSentenceId(0, text.length, text, false); sentences.push({ id: id, text: text, start: 0, end: text.length, isHeading: false }); } return sentences; } getPlainText() { return this.editor.textContent || this.editor.innerText || ''; } getContentHash() { return this.getPlainText().length + '-' + this.editor.innerHTML.length; } findActiveSentenceId(caretOffset) { const sentences = Array.from(this.sentenceMap.values()); const activeIndex = this.findActiveSentenceIndex(sentences, caretOffset); if (activeIndex >= 0 && activeIndex < sentences.length) { return sentences[activeIndex].id; } return null; } scanAndHighlight() { const text = this.getPlainText(); const isEmpty = !text.trim(); if (isEmpty) { this.clearAllHighlights(); this.sentenceMap.clear(); this.sentenceElements.clear(); this.activeSentenceId = null; this.lastContentHash = ''; return; } const contentHash = this.getContentHash(); const caretOffset = this.getCaretOffset(); const newSentences = this.buildSentenceMap(); if (newSentences.length === 0) { return; } const activeIndex = this.findActiveSentenceIndex(newSentences, caretOffset); const needsRebuild = contentHash !== this.lastContentHash || !this.sentenceElements || this.sentenceElements.size === 0 || !this.hasValidHighlights(); if (needsRebuild) { this.rebuildHighlights(newSentences, activeIndex, caretOffset); this.lastContentHash = contentHash; } else { this.updateActiveSentenceFromMap(newSentences, activeIndex); } this.sentenceMap.clear(); newSentences.forEach(s => { this.sentenceMap.set(s.id, s); }); if (this.options.onSentenceChange) { this.options.onSentenceChange(Array.from(this.sentenceMap.values())); } if (this.options.autoScroll) { this.scrollCaretToCenter(); } } findActiveSentenceIndex(sentences, caretOffset) { for (let i = 0; i < sentences.length; i++) { const s = sentences[i]; if (caretOffset >= s.start && caretOffset < s.end) { return i; } if (caretOffset === s.end && i < sentences.length - 1) { return i + 1; } } if (sentences.length > 0) { const lastSentence = sentences[sentences.length - 1]; if (caretOffset >= lastSentence.start) { return sentences.length - 1; } } return -1; } hasValidHighlights() { if (!this.sentenceElements) { return false; } return this.sentenceElements.size > 0 && this.editor.querySelectorAll(`[${this.options.sentenceDataAttribute}]`).length > 0; } clearAllHighlights() { if (!this.sentenceElements) { this.sentenceElements = new Map(); } const spans = this.editor.querySelectorAll(`[${this.options.sentenceDataAttribute}]`); spans.forEach(span => { const parent = span.parentNode; if (parent && parent !== this.editor) { while (span.firstChild) { parent.insertBefore(span.firstChild, span); } parent.removeChild(span); } }); const container = this.editor.querySelector(`.${this.options.containerClass}`); if (container) { const hasElements = Array.from(container.childNodes).some(node => node.nodeType === Node.ELEMENT_NODE ); if (!hasElements) { while (container.firstChild) { this.editor.insertBefore(container.firstChild, container); } this.editor.removeChild(container); } } this.sentenceElements.clear(); } rebuildHighlights(sentences, activeIndex, caretOffset) { if (sentences.length === 0) { this.clearAllHighlights(); return; } if (!this.sentenceElements) { this.sentenceElements = new Map(); } this.sentenceElements.clear(); const container = document.createElement('div'); container.className = this.options.containerClass; sentences.forEach((sentence, i) => { const span = document.createElement('span'); span.setAttribute(this.options.sentenceDataAttribute, sentence.id); span.className = this.options.sentenceClass; if (i === activeIndex && activeIndex >= 0) { span.classList.add(this.options.activeSentenceClass); span.setAttribute(this.options.activeSentenceDataAttribute, 'true'); this.activeSentenceId = sentence.id; } if (sentence.isHeading) { span.classList.add('sentence-highlighter-heading'); } span.textContent = sentence.text; container.appendChild(span); this.sentenceElements.set(sentence.id, span); }); const savedCaretOffset = caretOffset; this.editor.innerHTML = ''; this.editor.appendChild(container); requestAnimationFrame(() => { this.setCaretOffset(savedCaretOffset); }); } updateActiveSentenceFromMap(sentences, activeIndex) { if (!this.sentenceElements || activeIndex < 0 || activeIndex >= sentences.length) return; const newActiveId = sentences[activeIndex].id; if (this.activeSentenceId) { const oldElement = this.sentenceElements.get(this.activeSentenceId); if (oldElement) { oldElement.classList.remove(this.options.activeSentenceClass); oldElement.removeAttribute(this.options.activeSentenceDataAttribute); } } this.activeSentenceId = newActiveId; const newElement = this.sentenceElements.get(newActiveId); if (newElement) { newElement.classList.add(this.options.activeSentenceClass); newElement.setAttribute(this.options.activeSentenceDataAttribute, 'true'); } if (this.options.onActiveSentenceChange) { const sentence = this.sentenceMap.get(newActiveId); this.options.onActiveSentenceChange(activeIndex, sentence || null); } } updateActiveSentence() { if (!this.sentenceElements || this.sentenceMap.size === 0) return; const caretOffset = this.getCaretOffset(); const sentences = Array.from(this.sentenceMap.values()); const activeIndex = this.findActiveSentenceIndex(sentences, caretOffset); if (activeIndex < 0) return; const newActiveId = sentences[activeIndex].id; if (newActiveId === this.activeSentenceId) { return; } if (this.activeSentenceId) { const oldElement = this.sentenceElements.get(this.activeSentenceId); if (oldElement) { oldElement.classList.remove(this.options.activeSentenceClass); oldElement.removeAttribute(this.options.activeSentenceDataAttribute); } } this.activeSentenceId = newActiveId; const newElement = this.sentenceElements.get(newActiveId); if (newElement) { newElement.classList.add(this.options.activeSentenceClass); newElement.setAttribute(this.options.activeSentenceDataAttribute, 'true'); } if (this.options.onActiveSentenceChange) { const sentence = this.sentenceMap.get(newActiveId); this.options.onActiveSentenceChange(activeIndex, sentence || null); } if (this.options.autoScroll) { this.scrollCaretToCenter(); } } scrollCaretToCenter() { const selection = window.getSelection(); if (!selection || selection.rangeCount === 0) return; const range = selection.getRangeAt(0); if (!this.editor.contains(range.startContainer)) return; const caretRange = range.cloneRange(); caretRange.collapse(true); const marker = document.createElement('span'); marker.style.display = 'inline-block'; marker.style.width = '0'; marker.style.height = '1em'; marker.style.visibility = 'hidden'; marker.setAttribute('data-sentence-highlighter-marker', 'true'); try { caretRange.insertNode(marker); marker.scrollIntoView({ block: 'center', inline: 'nearest', behavior: this.options.scrollBehavior }); const newRange = document.createRange(); newRange.setStart(marker, 0); newRange.collapse(true); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(newRange); const parent = marker.parentNode; if (parent && marker.parentNode) { parent.removeChild(marker); } } catch (e) { } } setFocusMode(enabled) { this.focusModeEnabled = enabled; if (enabled) { this.editor.classList.remove('sentence-highlighter-focus-off'); } else { this.editor.classList.add('sentence-highlighter-focus-off'); } } toggleFocusMode() { this.setFocusMode(!this.focusModeEnabled); } getSentences() { return Array.from(this.sentenceMap.values()).map(s => ({ id: s.id, text: s.text, start: s.start, end: s.end, isHeading: s.isHeading })); } getActiveSentence() { if (!this.activeSentenceId) return null; const sentence = this.sentenceMap.get(this.activeSentenceId); return sentence ? { id: sentence.id, text: sentence.text, start: sentence.start, end: sentence.end, isHeading: sentence.isHeading } : null; } getActiveSentenceIndex() { if (!this.activeSentenceId) return -1; const ids = Array.from(this.sentenceMap.keys()); return ids.indexOf(this.activeSentenceId); } update() { this.scanAndHighlight(); } destroy() { clearTimeout(this.updateTimer); this.editor.removeEventListener('input', this.handleInput); this.editor.removeEventListener('click', this.handleNavigation); document.removeEventListener('selectionchange', this.handleCaretMove); for (const id of this.sentenceMap.keys()) { this.removeSentenceHighlight(id); } this.sentenceMap.clear(); this.sentenceElements.clear(); this.activeSentenceId = null; this.editor.classList.remove( this.options.containerClass, 'sentence-highlighter-focus-off' ); this.isInitialized = false; } } if (typeof module !== 'undefined' && module.exports) { module.exports = SentenceHighlighter; } else { window.SentenceHighlighter = SentenceHighlighter; } })(window || global);