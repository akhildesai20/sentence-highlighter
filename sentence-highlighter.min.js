!function(e){"use strict";class t{constructor(e,t={}){if(!e||!e.nodeType)throw new Error("SentenceHighlighter: Valid editor element is required");if(!e.isContentEditable)throw new Error("SentenceHighlighter: Element must be contenteditable");this.editor=e,this.options={sentenceDataAttribute:t.sentenceDataAttribute||"data-sentence-id",activeSentenceDataAttribute:t.activeSentenceDataAttribute||"data-sentence-active",containerClass:t.containerClass||"paragraph",sentenceClass:t.sentenceClass||"sentence",activeSentenceClass:t.activeSentenceClass||"sentence--active",enableFocusMode:!1!==t.enableFocusMode,focusModeDimOpacity:t.focusModeDimOpacity||.18,autoScroll:!1!==t.autoScroll,scrollBehavior:t.scrollBehavior||"smooth",headingTags:t.headingTags||["h1","h2","h3"],sentenceEndings:t.sentenceEndings||[".","!","?"],updateDebounce:t.updateDebounce||100,updateThrottle:t.updateThrottle||50,onSentenceChange:t.onSentenceChange||null,onActiveSentenceChange:t.onActiveSentenceChange||null,...t},this.sentenceMap=new Map,this.sentenceElements=new Map,this.activeSentenceId=null,this.isInitialized=!1,this.updateTimer=null,this.lastContentHash=null,this.focusModeEnabled=this.options.enableFocusMode,this.handleInput=this.handleInput.bind(this),this.handleNavigation=this.handleNavigation.bind(this),this.handleCaretMove=this.handleCaretMove.bind(this),this.init()}init(){this.isInitialized||(this.injectCSS(),this.editor.classList.add(this.options.containerClass),this.focusModeEnabled||this.editor.classList.add("sentence-highlighter-focus-off"),this.attachEvents(),setTimeout(()=>{this.scanAndHighlight()},10),this.isInitialized=!0)}injectCSS(){const e="sentence-highlighter-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent=`\n        .${this.options.containerClass} .${this.options.sentenceClass} {\n          opacity: ${this.options.focusModeDimOpacity};\n          transition: opacity 0.18s ease, color 0.18s ease;\n        }\n        \n        .${this.options.containerClass} .${this.options.sentenceClass}.${this.options.activeSentenceClass},\n        .${this.options.containerClass} .${this.options.sentenceClass}[${this.options.activeSentenceDataAttribute}] {\n          opacity: 1 !important;\n        }\n        \n        .sentence-highlighter-focus-off .${this.options.containerClass} .${this.options.sentenceClass} {\n          opacity: 1;\n        }\n      `,document.head.appendChild(t)}attachEvents(){this.editor.addEventListener("input",this.handleInput),this.editor.addEventListener("click",this.handleNavigation),this.editor.addEventListener("keyup",e=>{["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End","PageUp","PageDown"].includes(e.key)&&this.handleNavigation()}),document.addEventListener("selectionchange",this.handleCaretMove),this.editor.addEventListener("focus",()=>this.handleNavigation())}handleInput(){clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.scanAndHighlight()},this.options.updateDebounce)}handleNavigation(){clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.updateActiveSentence()},this.options.updateThrottle)}handleCaretMove(){this.editor.contains(e.getSelection()?.anchorNode)&&(clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.updateActiveSentence()},this.options.updateThrottle))}generateSentenceId(e,t,n,i){return`sentence-${this.simpleHash(`${e}-${t}-${n.substring(0,20)}-${i}`)}`}simpleHash(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}getCaretOffset(){const t=e.getSelection();if(!t||0===t.rangeCount)return 0;const n=t.getRangeAt(0),i=n.cloneRange();return i.selectNodeContents(this.editor),i.setEnd(n.endContainer,n.endOffset),i.toString().length}setCaretOffset(t){const n=e.getSelection(),i=document.createRange();let s=0,o=!1;const a=e=>{if(!o)if(e.nodeType===Node.TEXT_NODE){const n=e.textContent||"",a=s+n.length;if(t<=a){const n=t-s;return i.setStart(e,Math.max(0,n)),i.collapse(!0),void(o=!0)}s=a}else if(e.nodeType===Node.ELEMENT_NODE)for(let t=0;t<e.childNodes.length;t++)if(a(e.childNodes[t]),o)return};a(this.editor),o||(i.selectNodeContents(this.editor),i.collapse(!1)),n.removeAllRanges(),n.addRange(i)}buildSentenceMap(){const e=this.getPlainText();if(!e.trim())return[];const t=[],n=`[^${this.options.sentenceEndings.map(e=>"\\"+e).join("")}]+[${this.options.sentenceEndings.map(e=>"\\"+e).join("")}]?\\s*`,i=new RegExp(n,"g");let s,o=0;for(;null!==(s=i.exec(e));){const e=s[0],n=s.index,a=n+e.length,c=this.generateSentenceId(n,a,e,!1);t.push({id:c,text:e,start:n,end:a,isHeading:!1}),o=i.lastIndex}if(o<e.length){const n=e.substring(o);if(n.trim().length>0){const i=this.generateSentenceId(o,e.length,n,!1);t.push({id:i,text:n,start:o,end:e.length,isHeading:!1})}}if(0===t.length&&e.trim().length>0){const n=this.generateSentenceId(0,e.length,e,!1);t.push({id:n,text:e,start:0,end:e.length,isHeading:!1})}return t}getPlainText(){return this.editor.textContent||this.editor.innerText||""}getContentHash(){return this.getPlainText().length+"-"+this.editor.innerHTML.length}findActiveSentenceId(e){for(const[t,n]of this.sentenceMap)if(e>=n.start&&e<=n.end)return t;if(this.sentenceMap.size>0){return Array.from(this.sentenceMap.values()).pop().id}return null}scanAndHighlight(){if(!this.getPlainText().trim())return this.clearAllHighlights(),this.sentenceMap.clear(),this.sentenceElements.clear(),this.activeSentenceId=null,void(this.lastContentHash="");const e=this.getContentHash(),t=this.getCaretOffset(),n=this.buildSentenceMap();if(0===n.length)return;const i=this.findActiveSentenceIndex(n,t);e!==this.lastContentHash||!this.sentenceElements||0===this.sentenceElements.size||!this.hasValidHighlights()?(this.rebuildHighlights(n,i,t),this.lastContentHash=e):this.updateActiveSentenceFromMap(n,i),this.sentenceMap.clear(),n.forEach(e=>{this.sentenceMap.set(e.id,e)}),this.options.onSentenceChange&&this.options.onSentenceChange(Array.from(this.sentenceMap.values())),this.options.autoScroll&&this.scrollCaretToCenter()}findActiveSentenceIndex(e,t){for(let n=0;n<e.length;n++){const i=e[n];if(t>=i.start&&t<=i.end)return n}return e.length>0?e.length-1:-1}hasValidHighlights(){return!!this.sentenceElements&&(this.sentenceElements.size>0&&this.editor.querySelectorAll(`[${this.options.sentenceDataAttribute}]`).length>0)}clearAllHighlights(){this.sentenceElements||(this.sentenceElements=new Map);this.editor.querySelectorAll(`[${this.options.sentenceDataAttribute}]`).forEach(e=>{const t=e.parentNode;if(t&&t!==this.editor){for(;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e)}});const e=this.editor.querySelector(`.${this.options.containerClass}`);if(e){if(!Array.from(e.childNodes).some(e=>e.nodeType===Node.ELEMENT_NODE)){for(;e.firstChild;)this.editor.insertBefore(e.firstChild,e);this.editor.removeChild(e)}}this.sentenceElements.clear()}rebuildHighlights(e,t,n){if(0===e.length)return void this.clearAllHighlights();this.sentenceElements||(this.sentenceElements=new Map),this.sentenceElements.clear();const i=document.createElement("div");i.className=this.options.containerClass,e.forEach((e,n)=>{const s=document.createElement("span");s.setAttribute(this.options.sentenceDataAttribute,e.id),s.className=this.options.sentenceClass,n===t&&t>=0&&(s.classList.add(this.options.activeSentenceClass),s.setAttribute(this.options.activeSentenceDataAttribute,"true"),this.activeSentenceId=e.id),e.isHeading&&s.classList.add("sentence-highlighter-heading"),s.textContent=e.text,i.appendChild(s),this.sentenceElements.set(e.id,s)});const s=n;this.editor.innerHTML="",this.editor.appendChild(i),requestAnimationFrame(()=>{this.setCaretOffset(s)})}updateActiveSentenceFromMap(e,t){if(!this.sentenceElements||t<0||t>=e.length)return;const n=e[t].id;if(this.activeSentenceId){const e=this.sentenceElements.get(this.activeSentenceId);e&&(e.classList.remove(this.options.activeSentenceClass),e.removeAttribute(this.options.activeSentenceDataAttribute))}this.activeSentenceId=n;const i=this.sentenceElements.get(n);if(i&&(i.classList.add(this.options.activeSentenceClass),i.setAttribute(this.options.activeSentenceDataAttribute,"true")),this.options.onActiveSentenceChange){const e=this.sentenceMap.get(n);this.options.onActiveSentenceChange(t,e||null)}}updateActiveSentence(){if(!this.sentenceElements||0===this.sentenceMap.size)return;const e=this.getCaretOffset(),t=Array.from(this.sentenceMap.values()),n=this.findActiveSentenceIndex(t,e);if(n<0)return;const i=t[n].id;if(i===this.activeSentenceId)return;if(this.activeSentenceId){const e=this.sentenceElements.get(this.activeSentenceId);e&&(e.classList.remove(this.options.activeSentenceClass),e.removeAttribute(this.options.activeSentenceDataAttribute))}this.activeSentenceId=i;const s=this.sentenceElements.get(i);if(s&&(s.classList.add(this.options.activeSentenceClass),s.setAttribute(this.options.activeSentenceDataAttribute,"true")),this.options.onActiveSentenceChange){const e=this.sentenceMap.get(i);this.options.onActiveSentenceChange(n,e||null)}this.options.autoScroll&&this.scrollCaretToCenter()}scrollCaretToCenter(){const t=e.getSelection();if(!t||0===t.rangeCount)return;const n=t.getRangeAt(0);if(!this.editor.contains(n.startContainer))return;const i=n.cloneRange();i.collapse(!0);const s=document.createElement("span");s.style.display="inline-block",s.style.width="0",s.style.height="1em",s.style.visibility="hidden",s.setAttribute("data-sentence-highlighter-marker","true");try{i.insertNode(s),s.scrollIntoView({block:"center",inline:"nearest",behavior:this.options.scrollBehavior});const t=document.createRange();t.setStart(s,0),t.collapse(!0);const n=e.getSelection();n.removeAllRanges(),n.addRange(t);const o=s.parentNode;o&&s.parentNode&&o.removeChild(s)}catch(e){}}setFocusMode(e){this.focusModeEnabled=e,e?this.editor.classList.remove("sentence-highlighter-focus-off"):this.editor.classList.add("sentence-highlighter-focus-off")}toggleFocusMode(){this.setFocusMode(!this.focusModeEnabled)}getSentences(){return Array.from(this.sentenceMap.values()).map(e=>({id:e.id,text:e.text,start:e.start,end:e.end,isHeading:e.isHeading}))}getActiveSentence(){if(!this.activeSentenceId)return null;const e=this.sentenceMap.get(this.activeSentenceId);return e?{id:e.id,text:e.text,start:e.start,end:e.end,isHeading:e.isHeading}:null}getActiveSentenceIndex(){if(!this.activeSentenceId)return-1;return Array.from(this.sentenceMap.keys()).indexOf(this.activeSentenceId)}update(){this.scanAndHighlight()}destroy(){clearTimeout(this.updateTimer),this.editor.removeEventListener("input",this.handleInput),this.editor.removeEventListener("click",this.handleNavigation),document.removeEventListener("selectionchange",this.handleCaretMove);for(const e of this.sentenceMap.keys())this.removeSentenceHighlight(e);this.sentenceMap.clear(),this.sentenceElements.clear(),this.activeSentenceId=null,this.editor.classList.remove(this.options.containerClass,"sentence-highlighter-focus-off"),this.isInitialized=!1}}"undefined"!=typeof module&&module.exports?module.exports=t:e.SentenceHighlighter=t}(window||global);